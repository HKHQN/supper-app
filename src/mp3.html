<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nghe Nháº¡c & LÆ°u VÃ o Firebase</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #1db954;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .player {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    audio {
      width: 100%;
      margin: 15px 0;
    }
    .upload-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    input[type="text"] {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      flex: 1;
      min-width: 160px;
      background: #2a2a2a;
      color: #fff;
    }
    input[type="file"] {
      color: #ccc;
      font-size: 0.9rem;
    }
    button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      background: #1db954;
      color: white;
      cursor: pointer;
      white-space: nowrap;
    }
    button:hover { background: #1ed760; }
    button:disabled { background: #555; cursor: not-allowed; }

    #uploadStatus {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #b3b3b3;
      min-height: 20px;
    }
    .progress-bar {
      width: 100%;
      background: #333;
      border-radius: 4px;
      height: 6px;
      margin-top: 6px;
      display: none;
    }
    .progress-bar-inner {
      height: 6px;
      background: #1db954;
      border-radius: 4px;
      width: 0%;
      transition: width 0.2s;
    }

    #songList {
      list-style: none;
      padding: 0;
    }
    #songList li {
      background: #282828;
      margin: 10px 0;
      padding: 15px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      transition: background 0.2s;
    }
    #songList li:hover { background: #3a3a3a; }
    #songList li.playing { background: #1a3a2a; border-left: 3px solid #1db954; }
    #songList li .info { flex: 1; overflow: hidden; }
    #songList li .info strong { display: block; }
    #songList li .info small { color: #888; font-size: 0.8rem; }
    .btn-group { display: flex; gap: 6px; flex-shrink: 0; }
    .btn-play { background: #1db954; padding: 8px 14px; font-size: 0.9rem; }
    .btn-delete { background: #e63946; padding: 8px 14px; font-size: 0.9rem; }
    .btn-delete:hover { background: #ff5561; }

    #loopInfo {
      text-align: center;
      margin: 15px 0;
      color: #b3b3b3;
    }
    .size-warning {
      color: #f4a261;
      font-size: 0.85rem;
      margin-top: 4px;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸµ Nghe Nháº¡c & LÆ°u Firebase</h1>

  <div class="player">
    <h2>Äang phÃ¡t: <span id="currentTitle">ChÆ°a chá»n bÃ i</span></h2>
    <audio id="audioPlayer" controls></audio>

    <div class="upload-row">
      <input type="text" id="songTitle" placeholder="TÃªn bÃ i hÃ¡t (báº¯t buá»™c)" />
      <input type="file" id="songFile" accept="audio/*" />
      <button id="uploadBtn" onclick="uploadAndSave()">â¬† Upload & LÆ°u</button>
    </div>
    <div class="size-warning">âš  Giá»›i háº¡n file: 5MB (Firebase Realtime DB lÆ°u Base64)</div>
    <div id="uploadStatus"></div>
    <div class="progress-bar" id="progressBar">
      <div class="progress-bar-inner" id="progressInner"></div>
    </div>
  </div>

  <div id="loopInfo">Danh sÃ¡ch bÃ i hÃ¡t (realtime)</div>
  <ul id="songList"></ul>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // â”€â”€ Firebase init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const firebaseConfig = {
    databaseURL: "https://supperdatabase-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const songsRef = db.ref("songs");

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const audio        = document.getElementById("audioPlayer");
  const currentTitle = document.getElementById("currentTitle");
  const songList     = document.getElementById("songList");
  const uploadBtn    = document.getElementById("uploadBtn");
  const statusEl     = document.getElementById("uploadStatus");
  const progressBar  = document.getElementById("progressBar");
  const progressInner= document.getElementById("progressInner");

  let currentKey = null;   // key cá»§a bÃ i Ä‘ang phÃ¡t
  let songKeys   = [];     // thá»© tá»± key trong danh sÃ¡ch

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(msg, color = "#b3b3b3") {
    statusEl.style.color = color;
    statusEl.textContent = msg;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + " B";
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
    return (bytes / (1024 * 1024)).toFixed(2) + " MB";
  }

  function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload  = () => resolve(reader.result); // data:audio/...;base64,...
      reader.onerror = () => reject(reader.error);
      reader.onprogress = (e) => {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded / e.total * 100);
          progressInner.style.width = pct + "%";
        }
      };
      reader.readAsDataURL(file);
    });
  }

  // â”€â”€ PhÃ¡t nháº¡c â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function playSong(key, base64, title) {
    currentKey = key;
    audio.src  = base64;
    audio.play().catch(err => alert("KhÃ´ng phÃ¡t Ä‘Æ°á»£c: " + err.message));
    currentTitle.textContent = title || "KhÃ´ng cÃ³ tiÃªu Ä‘á»";

    // Highlight bÃ i Ä‘ang phÃ¡t
    document.querySelectorAll("#songList li").forEach(li => {
      li.classList.toggle("playing", li.dataset.key === key);
    });
  }

  // â”€â”€ XÃ³a bÃ i â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function deleteSong(key) {
    if (!confirm("XÃ³a bÃ i nÃ y?")) return;
    // Náº¿u Ä‘ang phÃ¡t bÃ i nÃ y thÃ¬ dá»«ng
    if (key === currentKey) {
      audio.pause();
      audio.src = "";
      currentTitle.textContent = "ChÆ°a chá»n bÃ i";
      currentKey = null;
    }
    songsRef.child(key).remove().catch(err => alert("Lá»—i xÃ³a: " + err.message));
  }

  // â”€â”€ Danh sÃ¡ch realtime â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  songsRef.on("value", (snapshot) => {
    songList.innerHTML = "";
    songKeys = [];

    const data = snapshot.val();
    if (!data) {
      songList.innerHTML = "<li style='justify-content:center;color:#888'>ChÆ°a cÃ³ bÃ i hÃ¡t nÃ o.</li>";
      return;
    }

    Object.entries(data).forEach(([key, song]) => {
      songKeys.push(key);
      const li = document.createElement("li");
      li.dataset.key = key;
      if (key === currentKey) li.classList.add("playing");

      const info = document.createElement("div");
      info.className = "info";
      info.innerHTML = `<strong>${escapeHtml(song.title || "KhÃ´ng tÃªn")}</strong>
                        <small>${song.size || ""} Â· ${song.mimeType || ""}</small>`;

      const btnGroup = document.createElement("div");
      btnGroup.className = "btn-group";

      const playBtn = document.createElement("button");
      playBtn.className = "btn-play";
      playBtn.textContent = "â–¶ PhÃ¡t";
      playBtn.onclick = () => playSong(key, song.base64, song.title);

      const delBtn = document.createElement("button");
      delBtn.className = "btn-delete";
      delBtn.textContent = "ğŸ—‘ XÃ³a";
      delBtn.onclick = () => deleteSong(key);

      btnGroup.appendChild(playBtn);
      btnGroup.appendChild(delBtn);
      li.appendChild(info);
      li.appendChild(btnGroup);
      songList.appendChild(li);
    });
  });

  // â”€â”€ Upload & lÆ°u â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function uploadAndSave() {
    const title    = document.getElementById("songTitle").value.trim();
    const fileInput= document.getElementById("songFile");

    if (!title) { alert("Vui lÃ²ng nháº­p tÃªn bÃ i hÃ¡t!"); return; }
    if (!fileInput.files.length) { alert("Vui lÃ²ng chá»n file nháº¡c!"); return; }

    const file = fileInput.files[0];
    const MAX_MB = 5;
    if (file.size > MAX_MB * 1024 * 1024) {
      alert(`File quÃ¡ lá»›n! Giá»›i háº¡n ${MAX_MB}MB, file cá»§a báº¡n: ${formatSize(file.size)}`);
      return;
    }

    uploadBtn.disabled = true;
    progressBar.style.display = "block";
    progressInner.style.width = "0%";
    setStatus("Äang Ä‘á»c file...", "#b3b3b3");

    try {
      const base64 = await readFileAsBase64(file);
      setStatus("Äang lÆ°u lÃªn Firebase...", "#b3b3b3");
      progressInner.style.width = "100%";

      await songsRef.push({
        title      : title,
        base64     : base64,          // âœ… lÆ°u Base64 thay vÃ¬ blob URL
        mimeType   : file.type,
        size       : formatSize(file.size),
        uploadedAt : Date.now()
      });

      setStatus(`âœ… ÄÃ£ lÆ°u: "${title}"`, "#1db954");
      document.getElementById("songTitle").value = "";
      fileInput.value = "";
    } catch (err) {
      setStatus("âŒ Lá»—i: " + err.message, "#e63946");
    } finally {
      uploadBtn.disabled = false;
      setTimeout(() => { progressBar.style.display = "none"; }, 1500);
    }
  }

  // â”€â”€ Auto-next (loop playlist) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  audio.addEventListener("ended", () => {
    if (songKeys.length === 0) return;
    const idx     = songKeys.indexOf(currentKey);
    const nextIdx = (idx + 1) % songKeys.length;   // vÃ²ng láº¡i Ä‘áº§u danh sÃ¡ch
    const nextKey = songKeys[nextIdx];

    // Láº¥y data bÃ i tiáº¿p theo tá»« Firebase
    songsRef.child(nextKey).once("value").then(snap => {
      const song = snap.val();
      if (song) playSong(nextKey, song.base64, song.title);
    });
  });

  // â”€â”€ XSS protection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }
</script>

</body>
</html>
