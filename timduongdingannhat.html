<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dijkstra – Đường đi ngắn nhất</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Sora:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0f14;
      --surface: #161a23;
      --surface2: #1e2433;
      --border: #2a3147;
      --accent: #00e5a0;
      --accent2: #3b7bff;
      --warn: #f59e0b;
      --danger: #ef4444;
      --text: #e2e8f0;
      --muted: #64748b;
      --node-default: #3b7bff;
      --node-source: #ef4444;
      --node-visited: #00e5a0;
      --edge-default: #2a3147;
      --edge-highlight: #f59e0b;
      --radius: 12px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Sora', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header .logo {
      width: 36px; height: 36px;
      background: var(--accent);
      border-radius: 8px;
      display: grid; place-items: center;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      color: #000;
      font-size: 14px;
      flex-shrink: 0;
    }
    header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.3px;
    }
    header p { font-size: 12px; color: var(--muted); }
    header .status {
      margin-left: auto;
      display: flex; align-items: center; gap: 8px;
      font-size: 12px; color: var(--muted);
    }
    header .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--muted);
      transition: background .3s;
    }
    header .dot.online { background: var(--accent); box-shadow: 0 0 6px var(--accent); }

    /* LAYOUT */
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 0;
      overflow: hidden;
    }

    /* CANVAS AREA */
    .canvas-area {
      display: flex; flex-direction: column;
      border-right: 1px solid var(--border);
      overflow: hidden;
    }
    .canvas-toolbar {
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .btn {
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Sora', sans-serif;
      font-weight: 500;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all .15s;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-accent { background: var(--accent); color: #000; }
    .btn-accent:hover { background: #00ffb3; }
    .btn-blue { background: var(--accent2); color: #fff; }
    .btn-blue:hover { background: #5591ff; }
    .btn-purple { background: #8b5cf6; color: #fff; }
    .btn-purple:hover { background: #a78bfa; }
    .btn-red { background: transparent; color: var(--danger); border-color: var(--danger); }
    .btn-red:hover { background: var(--danger); color: #fff; }
    .btn-ghost { background: transparent; color: var(--muted); border-color: var(--border); }
    .btn-ghost:hover { color: var(--text); border-color: var(--muted); }
    .btn.active-mode {
      outline: 2px solid var(--warn);
      outline-offset: 2px;
    }

    .canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    #canvas {
      width: 100%; height: 100%;
      display: block;
      cursor: crosshair;
    }

    .mode-badge {
      position: absolute;
      top: 12px; left: 50%; transform: translateX(-50%);
      background: var(--warn);
      color: #000;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 14px;
      border-radius: 999px;
      pointer-events: none;
      display: none;
      font-family: 'JetBrains Mono', monospace;
    }
    .mode-badge.visible { display: block; }

    /* RESULT BOX */
    .result-box {
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 13px;
    }
    .result-box h4 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 8px;
      font-family: 'JetBrains Mono', monospace;
    }
    .result-row {
      display: flex; align-items: baseline; gap: 10px;
      padding: 5px 0;
      border-bottom: 1px solid var(--border);
    }
    .result-row:last-child { border-bottom: none; }
    .result-node { font-weight: 700; color: var(--accent); min-width: 24px; }
    .result-dist { font-family: 'JetBrains Mono', monospace; color: var(--warn); min-width: 36px; }
    .result-path { color: var(--muted); font-size: 12px; }
    .result-inf { color: var(--danger); }

    /* SIDEBAR */
    .sidebar {
      display: flex; flex-direction: column;
      overflow: hidden;
      background: var(--surface);
    }
    .sidebar-section {
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }
    .sidebar-section h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 12px;
      font-family: 'JetBrains Mono', monospace;
    }
    .source-select {
      width: 100%;
      padding: 9px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Sora', sans-serif;
      font-size: 14px;
      appearance: none;
      cursor: pointer;
    }
    .source-select:focus { outline: 2px solid var(--accent); border-color: transparent; }

    .node-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .node-list h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 10px;
      font-family: 'JetBrains Mono', monospace;
    }
    .node-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--surface2);
      margin-bottom: 6px;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    .node-item .name {
      font-weight: 700;
      color: var(--accent2);
      font-family: 'JetBrains Mono', monospace;
    }
    .node-item .coords { font-size: 11px; color: var(--muted); }
    .node-item .actions { display: flex; gap: 4px; }
    .icon-btn {
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      transition: .15s;
    }
    .icon-btn.edit { background: rgba(59,123,255,.15); color: var(--accent2); }
    .icon-btn.edit:hover { background: var(--accent2); color: #fff; }
    .icon-btn.del { background: rgba(239,68,68,.15); color: var(--danger); }
    .icon-btn.del:hover { background: var(--danger); color: #fff; }

    .edge-list { margin-top: 12px; }
    .edge-list h3 {
      font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
      color: var(--muted); margin-bottom: 10px;
      font-family: 'JetBrains Mono', monospace;
    }
    .edge-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 7px 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 5px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
    }
    .edge-item .route { color: var(--text); }
    .edge-item .w { color: var(--warn); font-weight: 700; }
    .edge-item .del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 14px; }
    .edge-item .del:hover { color: var(--danger); }

    /* MODAL */
    #modal {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.75);
      z-index: 100;
      place-items: center;
    }
    #modal.open { display: grid; }
    .modal-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      width: 100%;
      max-width: 400px;
      margin: 16px;
      box-shadow: 0 32px 64px rgba(0,0,0,.5);
    }
    .modal-box h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--accent);
    }
    .field { margin-bottom: 14px; }
    .field label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .field input, .field select {
      width: 100%;
      padding: 9px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Sora', sans-serif;
      font-size: 14px;
    }
    .field input:focus, .field select:focus {
      outline: 2px solid var(--accent);
      border-color: transparent;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* Empty states */
    .empty { color: var(--muted); font-size: 12px; text-align: center; padding: 16px; }

    @media (max-width: 768px) {
      main { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
      .canvas-area { min-height: 50vh; }
      .sidebar { max-height: 50vh; overflow-y: auto; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">DJ</div>
  <div>
    <h1>Dijkstra Shortest Path</h1>
    <p>Nghiên cứu đường đi ngắn nhất trên đồ thị</p>
  </div>
  <div class="status">
    <div class="dot" id="statusDot"></div>
    <span id="statusText">Đang kết nối...</span>
  </div>
</header>

<main>
  <!-- LEFT: Canvas + controls -->
  <div class="canvas-area">
    <div class="canvas-toolbar">
      <button class="btn btn-accent" id="btnAddNode">＋ Thêm đỉnh</button>
      <button class="btn btn-blue" id="btnAddEdge">⟶ Thêm cạnh</button>
      <button class="btn btn-purple" id="btnRun">▶ Chạy Dijkstra</button>
      <button class="btn btn-ghost" id="btnResetView">↺ Đặt lại</button>
      <button class="btn btn-red" id="btnClear">✕ Xóa tất cả</button>
    </div>

    <div class="canvas-wrap">
      <canvas id="canvas"></canvas>
      <div class="mode-badge" id="modeBadge">CHẾ ĐỘ THÊM CẠNH</div>
    </div>

    <div class="result-box" id="resultBox">
      <h4>KẾT QUẢ DIJKSTRA</h4>
      <div class="empty">Chọn đỉnh nguồn và nhấn "Chạy Dijkstra" để xem kết quả.</div>
    </div>
  </div>

  <!-- RIGHT: Sidebar -->
  <div class="sidebar">
    <div class="sidebar-section">
      <h3>Đỉnh nguồn</h3>
      <select class="source-select" id="sourceSelect">
        <option value="">Chọn đỉnh nguồn...</option>
      </select>
    </div>
    <div class="node-list" id="nodeList">
      <h3>Đỉnh (0)</h3>
      <div class="empty">Chưa có đỉnh nào. Nhấn "+ Thêm đỉnh".</div>
      <div class="edge-list">
        <h3>Cạnh (0)</h3>
        <div class="empty">Chưa có cạnh nào.</div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Thêm đỉnh</h3>
    <form id="modalForm" autocomplete="off">
      <input type="hidden" id="editType">
      <input type="hidden" id="editId">

      <div id="nodeFields">
        <div class="field">
          <label>Tên đỉnh (A, B, 1, 2…)</label>
          <input type="text" id="nodeName" maxlength="5" placeholder="VD: A">
        </div>
        <div class="field">
          <label>Tọa độ X</label>
          <input type="number" id="nx" min="30" max="760" value="100">
        </div>
        <div class="field">
          <label>Tọa độ Y</label>
          <input type="number" id="ny" min="30" max="460" value="100">
        </div>
      </div>

      <div id="edgeFields" style="display:none">
        <div class="field">
          <label>Từ đỉnh</label>
          <select id="edgeFrom"></select>
        </div>
        <div class="field">
          <label>Đến đỉnh</label>
          <select id="edgeTo"></select>
        </div>
        <div class="field">
          <label>Trọng số</label>
          <input type="number" id="edgeWeight" min="1" max="9999" value="1">
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" id="btnCancel">Hủy</button>
        <button type="submit" class="btn btn-accent">Lưu</button>
      </div>
    </form>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

// ── Firebase ──────────────────────────────────────────────────────────
const app = initializeApp({ databaseURL: "https://supperdatabase-default-rtdb.firebaseio.com/" });
const db  = getDatabase(app);
const ROOT = ref(db, 'dijkstra_v2');

const statusDot  = document.getElementById('statusDot');
const statusText = document.getElementById('statusText');

// ── State ─────────────────────────────────────────────────────────────
// nodes: { id: { name, x, y } }
// edges: [ { id, from, to, weight } ]
let nodes = {};
let edges = [];
let mode  = 'select'; // 'select' | 'addEdge'
let edgeStart = null; // node id
let highlightNodes = new Set();
let highlightEdges = new Set(); // edge ids
let dijkstraRan = false;

// ── Canvas ────────────────────────────────────────────────────────────
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');
const NODE_R = 20;

function resizeCanvas() {
  const wrap = canvas.parentElement;
  canvas.width  = wrap.clientWidth;
  canvas.height = wrap.clientHeight;
  draw();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// ── Draw ──────────────────────────────────────────────────────────────
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Grid dots
  ctx.fillStyle = 'rgba(255,255,255,0.03)';
  for (let x = 20; x < canvas.width; x += 40)
    for (let y = 20; y < canvas.height; y += 40)
      ctx.fillRect(x, y, 2, 2);

  // Edges
  edges.forEach(e => {
    const from = nodes[e.from];
    const to   = nodes[e.to];
    if (!from || !to) return;

    const isHighlight = highlightEdges.has(e.id);
    ctx.beginPath();
    ctx.moveTo(from.x, from.y);
    ctx.lineTo(to.x, to.y);
    ctx.strokeStyle = isHighlight ? '#f59e0b' : 'rgba(255,255,255,0.12)';
    ctx.lineWidth   = isHighlight ? 3.5 : 1.5;
    ctx.stroke();

    // Arrowhead
    const angle = Math.atan2(to.y - from.y, to.x - from.x);
    const ax = to.x - (NODE_R + 5) * Math.cos(angle);
    const ay = to.y - (NODE_R + 5) * Math.sin(angle);
    ctx.beginPath();
    ctx.moveTo(ax, ay);
    ctx.lineTo(ax - 10 * Math.cos(angle - 0.4), ay - 10 * Math.sin(angle - 0.4));
    ctx.lineTo(ax - 10 * Math.cos(angle + 0.4), ay - 10 * Math.sin(angle + 0.4));
    ctx.closePath();
    ctx.fillStyle = isHighlight ? '#f59e0b' : 'rgba(255,255,255,0.2)';
    ctx.fill();

    // Weight label
    const mx = (from.x + to.x) / 2;
    const my = (from.y + to.y) / 2;
    const perp = Math.atan2(to.y - from.y, to.x - from.x) + Math.PI / 2;
    const lx = mx + 14 * Math.cos(perp);
    const ly = my + 14 * Math.sin(perp);
    ctx.font = 'bold 12px JetBrains Mono, monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = isHighlight ? '#f59e0b' : 'rgba(255,255,255,0.5)';
    ctx.fillText(e.weight, lx, ly);
  });

  // Nodes
  Object.values(nodes).forEach(n => {
    const sourceId = document.getElementById('sourceSelect').value;
    const isSource  = n.id === sourceId;
    const isVisited = highlightNodes.has(n.id);
    const isEdgeStart = n.id === edgeStart;

    // Glow
    if (isSource || isVisited || isEdgeStart) {
      const glowColor = isEdgeStart ? '#f59e0b' : isSource ? '#ef4444' : '#00e5a0';
      const grad = ctx.createRadialGradient(n.x, n.y, 5, n.x, n.y, 38);
      grad.addColorStop(0, glowColor + '55');
      grad.addColorStop(1, 'transparent');
      ctx.beginPath();
      ctx.arc(n.x, n.y, 38, 0, Math.PI * 2);
      ctx.fillStyle = grad;
      ctx.fill();
    }

    // Circle
    ctx.beginPath();
    ctx.arc(n.x, n.y, NODE_R, 0, Math.PI * 2);
    let fill = '#3b7bff';
    if (isEdgeStart) fill = '#f59e0b';
    else if (isSource) fill = '#ef4444';
    else if (isVisited) fill = '#00e5a0';

    ctx.fillStyle = fill;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Label
    ctx.fillStyle = isVisited && !isSource ? '#000' : '#fff';
    ctx.font = 'bold 13px Sora, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(n.name, n.x, n.y);
  });
}

// ── Canvas interaction ────────────────────────────────────────────────
function getNodeAt(x, y) {
  return Object.values(nodes).find(n => {
    const dx = n.x - x, dy = n.y - y;
    return dx*dx + dy*dy <= NODE_R * NODE_R;
  });
}

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (canvas.width / rect.width);
  const y = (e.clientY - rect.top)  * (canvas.height / rect.height);

  if (mode === 'addEdge') {
    const node = getNodeAt(x, y);
    if (!node) return;
    if (!edgeStart) {
      edgeStart = node.id;
      draw();
      return;
    }
    if (edgeStart === node.id) {
      edgeStart = null; draw(); return;
    }
    // Open modal to confirm weight
    openEdgeModal(edgeStart, node.id);
    edgeStart = null;
    return;
  }
});

canvas.addEventListener('dblclick', e => {
  if (mode !== 'select') return;
  const rect = canvas.getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left) * (canvas.width / rect.width));
  const y = Math.round((e.clientY - rect.top)  * (canvas.height / rect.height));
  const existing = getNodeAt(x, y);
  if (existing) {
    openNodeModal(existing);
  } else {
    openNodeModal(null, x, y);
  }
});

// ── Modes ──────────────────────────────────────────────────────────────
const modeBadge = document.getElementById('modeBadge');

document.getElementById('btnAddNode').onclick = () => openNodeModal(null, 100, 100);

document.getElementById('btnAddEdge').onclick = () => {
  mode = mode === 'addEdge' ? 'select' : 'addEdge';
  edgeStart = null;
  document.getElementById('btnAddEdge').classList.toggle('active-mode', mode === 'addEdge');
  modeBadge.classList.toggle('visible', mode === 'addEdge');
  canvas.style.cursor = mode === 'addEdge' ? 'crosshair' : 'default';
  draw();
};

document.getElementById('btnResetView').onclick = () => {
  highlightNodes.clear();
  highlightEdges.clear();
  dijkstraRan = false;
  document.getElementById('resultBox').innerHTML = '<h4>KẾT QUẢ DIJKSTRA</h4><div class="empty">Chọn đỉnh nguồn và nhấn "Chạy Dijkstra".</div>';
  draw();
};

document.getElementById('btnClear').onclick = () => {
  if (!confirm('Xóa toàn bộ đồ thị? Hành động này không thể hoàn tác.')) return;
  nodes = {}; edges = [];
  highlightNodes.clear(); highlightEdges.clear();
  saveGraph();
};

// ── Modal helpers ─────────────────────────────────────────────────────
const modal      = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalForm  = document.getElementById('modalForm');

function openNodeModal(node, defaultX, defaultY) {
  document.getElementById('editType').value = 'node';
  document.getElementById('editId').value   = node ? node.id : '';
  document.getElementById('nodeName').value = node ? node.name : '';
  document.getElementById('nx').value       = node ? node.x : (defaultX ?? 100);
  document.getElementById('ny').value       = node ? node.y : (defaultY ?? 100);
  document.getElementById('nodeFields').style.display = '';
  document.getElementById('edgeFields').style.display = 'none';
  modalTitle.textContent = node ? `Sửa đỉnh ${node.name}` : 'Thêm đỉnh mới';
  modal.classList.add('open');
  document.getElementById('nodeName').focus();
}

function openEdgeModal(fromId, toId) {
  const nodeKeys = Object.keys(nodes);
  if (nodeKeys.length < 2) return;

  // Populate selects
  const fromSel = document.getElementById('edgeFrom');
  const toSel   = document.getElementById('edgeTo');
  fromSel.innerHTML = '';
  toSel.innerHTML   = '';
  Object.values(nodes).forEach(n => {
    fromSel.insertAdjacentHTML('beforeend', `<option value="${n.id}" ${n.id===fromId?'selected':''}>${n.name}</option>`);
    toSel.insertAdjacentHTML('beforeend',   `<option value="${n.id}" ${n.id===toId?'selected':''}>${n.name}</option>`);
  });
  document.getElementById('edgeWeight').value = 1;
  document.getElementById('editType').value = 'edge';
  document.getElementById('editId').value = '';
  document.getElementById('nodeFields').style.display = 'none';
  document.getElementById('edgeFields').style.display = '';
  modalTitle.textContent = 'Thêm cạnh';
  modal.classList.add('open');
  document.getElementById('edgeWeight').focus();
}

document.getElementById('btnCancel').onclick = closeModal;
modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
function closeModal() {
  modal.classList.remove('open');
  document.getElementById('modalForm').reset();
}

// ── Form submit ───────────────────────────────────────────────────────
modalForm.addEventListener('submit', e => {
  e.preventDefault();
  const type = document.getElementById('editType').value;

  if (type === 'node') {
    const rawName = document.getElementById('nodeName').value.trim();
    if (!rawName) return alert('Tên đỉnh không được để trống.');
    const name = rawName.toUpperCase();
    const x    = Number(document.getElementById('nx').value);
    const y    = Number(document.getElementById('ny').value);
    const id   = document.getElementById('editId').value || generateId();

    // Check duplicate name (ignoring own id on edit)
    const dup = Object.values(nodes).find(n => n.name === name && n.id !== id);
    if (dup) return alert(`Đã tồn tại đỉnh tên "${name}".`);

    nodes[id] = { id, name, x, y };
    saveGraph();
  }

  if (type === 'edge') {
    const from   = document.getElementById('edgeFrom').value;
    const to     = document.getElementById('edgeTo').value;
    const weight = Number(document.getElementById('edgeWeight').value);

    if (from === to) return alert('Đỉnh nguồn và đích không được trùng nhau.');
    if (!weight || weight < 1) return alert('Trọng số phải ≥ 1.');

    // Prevent duplicate edge
    const dup = edges.find(e => e.from === from && e.to === to);
    if (dup) {
      if (!confirm(`Đã có cạnh ${nodes[from]?.name}→${nodes[to]?.name}. Ghi đè trọng số?`)) return;
      dup.weight = weight;
    } else {
      edges.push({ id: generateId(), from, to, weight });
    }
    saveGraph();
  }

  closeModal();
});

// ── Delete helpers ────────────────────────────────────────────────────
window.deleteNode = id => {
  if (!confirm(`Xóa đỉnh "${nodes[id]?.name}" và tất cả cạnh liên quan?`)) return;
  delete nodes[id];
  edges = edges.filter(e => e.from !== id && e.to !== id);
  saveGraph();
};

window.deleteEdge = id => {
  edges = edges.filter(e => e.id !== id);
  saveGraph();
};

window.editNode = id => openNodeModal(nodes[id]);

// ── Dijkstra ──────────────────────────────────────────────────────────
document.getElementById('btnRun').onclick = () => {
  const srcId = document.getElementById('sourceSelect').value;
  if (!srcId) return alert('Vui lòng chọn đỉnh nguồn!');
  if (Object.keys(nodes).length === 0) return alert('Đồ thị chưa có đỉnh nào.');

  const dist = {};
  const prev = {};
  const visited = new Set();

  Object.keys(nodes).forEach(id => dist[id] = Infinity);
  dist[srcId] = 0;

  const unvisited = new Set(Object.keys(nodes));

  while (unvisited.size > 0) {
    // Pick min
    let u = null;
    unvisited.forEach(id => {
      if (u === null || dist[id] < dist[u]) u = id;
    });
    if (u === null || dist[u] === Infinity) break;
    unvisited.delete(u);
    visited.add(u);

    // Neighbors
    edges.filter(e => e.from === u).forEach(e => {
      const alt = dist[u] + Number(e.weight);
      if (alt < dist[e.to]) {
        dist[e.to] = alt;
        prev[e.to] = u;
      }
    });
  }

  // Build result & highlight
  highlightNodes.clear();
  highlightEdges.clear();

  // Reconstruct path edges for all reachable nodes
  Object.keys(nodes).forEach(id => {
    if (dist[id] < Infinity) {
      highlightNodes.add(id);
      let cur = id;
      while (prev[cur]) {
        const p = prev[cur];
        const e = edges.find(e => e.from === p && e.to === cur);
        if (e) highlightEdges.add(e.id);
        cur = p;
      }
    }
  });

  // Render result
  const srcName = nodes[srcId]?.name ?? srcId;
  let html = `<h4>KẾT QUẢ TỪ ĐỈNH <span style="color:var(--accent)">${srcName}</span></h4>`;

  const sortedIds = Object.keys(nodes).sort((a, b) => {
    if (dist[a] === Infinity && dist[b] === Infinity) return 0;
    if (dist[a] === Infinity) return 1;
    if (dist[b] === Infinity) return -1;
    return dist[a] - dist[b];
  });

  sortedIds.forEach(id => {
    const n = nodes[id];
    if (!n) return;
    const d = dist[id];
    let path = [];
    if (d < Infinity) {
      let cur = id;
      while (cur) { path.unshift(nodes[cur]?.name ?? cur); cur = prev[cur]; }
    }
    html += `<div class="result-row">
      <span class="result-node">${n.name}</span>
      <span class="result-dist ${d===Infinity?'result-inf':''}">${d===Infinity?'∞':d}</span>
      <span class="result-path">${d<Infinity ? path.join(' → ') : 'Không thể đến'}</span>
    </div>`;
  });

  document.getElementById('resultBox').innerHTML = html;
  draw();
};

// ── Render sidebar ─────────────────────────────────────────────────────
function renderSidebar() {
  const nl = document.getElementById('nodeList');
  const srcSel = document.getElementById('sourceSelect');

  // Node list
  const nodeIds = Object.keys(nodes);
  let html = `<h3>Đỉnh (${nodeIds.length})</h3>`;
  if (nodeIds.length === 0) html += '<div class="empty">Chưa có đỉnh. Nhấn "+ Thêm đỉnh" hoặc double-click canvas.</div>';
  else nodeIds.forEach(id => {
    const n = nodes[id];
    html += `<div class="node-item">
      <div>
        <div class="name">${n.name}</div>
        <div class="coords">(${n.x}, ${n.y})</div>
      </div>
      <div class="actions">
        <button class="icon-btn edit" onclick="editNode('${id}')">✎</button>
        <button class="icon-btn del" onclick="deleteNode('${id}')">✕</button>
      </div>
    </div>`;
  });

  // Edge list
  html += `<div class="edge-list"><h3>Cạnh (${edges.length})</h3>`;
  if (edges.length === 0) html += '<div class="empty">Chưa có cạnh. Nhấn "⟶ Thêm cạnh".</div>';
  else edges.forEach(e => {
    const f = nodes[e.from]?.name ?? '?';
    const t = nodes[e.to]?.name ?? '?';
    html += `<div class="edge-item">
      <span class="route">${f} → ${t}</span>
      <span class="w">${e.weight}</span>
      <button class="del" onclick="deleteEdge('${e.id}')">✕</button>
    </div>`;
  });
  html += '</div>';
  nl.innerHTML = html;

  // Source select
  const prev = srcSel.value;
  srcSel.innerHTML = '<option value="">Chọn đỉnh nguồn...</option>';
  nodeIds.forEach(id => {
    const n = nodes[id];
    srcSel.insertAdjacentHTML('beforeend', `<option value="${id}" ${id===prev?'selected':''}>${n.name}</option>`);
  });
}

// ── Firebase sync ──────────────────────────────────────────────────────
function saveGraph() {
  set(ROOT, { nodes, edges }).catch(err => {
    console.error('Save failed', err);
    statusDot.classList.remove('online');
    statusText.textContent = 'Lỗi kết nối';
  });
}

onValue(ROOT, snap => {
  statusDot.classList.add('online');
  statusText.textContent = 'Đã kết nối';

  const data = snap.val();
  if (!data) { nodes = {}; edges = []; }
  else {
    nodes = data.nodes ?? {};
    edges = data.edges ?? [];

    // Data integrity: ensure all nodes have id field
    Object.entries(nodes).forEach(([id, n]) => {
      if (!n.id) nodes[id].id = id;
    });
    // Ensure edges have id
    edges = edges.map(e => ({ id: e.id ?? generateId(), ...e }));
    // Remove edges referencing non-existent nodes
    edges = edges.filter(e => nodes[e.from] && nodes[e.to]);
  }

  renderSidebar();
  draw();
}, err => {
  statusDot.classList.remove('online');
  statusText.textContent = 'Mất kết nối';
  console.error(err);
});

// ── Utils ──────────────────────────────────────────────────────────────
function generateId() {
  return 'n' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
}
</script>
</body>
</html>
